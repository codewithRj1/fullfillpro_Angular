<div class="space-y-6 animate-fade-in">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div>
            <h1 class="text-2xl font-display font-bold">Products</h1>
            <p class="text-muted-foreground">Manage your product catalog across all marketplaces</p>
        </div>
        <div class="flex items-center gap-2">
            <button
                class="btn-futuristic px-4 py-2 bg-card border border-border rounded-lg text-sm font-medium hover:bg-accent/50 flex items-center gap-2"
                (click)="openImportDialog()">
                <lucide-icon name="upload" class="w-4 h-4"></lucide-icon> Import
            </button>
            <button
                class="btn-futuristic px-4 py-2 bg-card border border-border rounded-lg text-sm font-medium hover:bg-accent/50 flex items-center gap-2"
                (click)="handleExport()">
                <lucide-icon name="download" class="w-4 h-4"></lucide-icon> Export
            </button>
            <button
                class="btn-futuristic px-4 py-2 bg-primary text-primary-foreground rounded-lg text-sm font-medium shadow-glow-sm hover:shadow-glow-md flex items-center gap-2"
                (click)="handleAddProduct()">
                <lucide-icon name="plus" class="w-4 h-4"></lucide-icon> Add Product
            </button>
            <button
                class="btn-futuristic px-4 py-2 bg-secondary text-secondary-foreground rounded-lg text-sm font-medium hover:bg-secondary/80 flex items-center gap-2"
                (click)="syncInventory()">
                <lucide-icon name="refresh-cw" class="w-4 h-4"></lucide-icon> Sync Inventory
            </button>
        </div>
    </div>

    <!-- Filters -->
    <div class="flex flex-col sm:flex-row gap-4 p-4 bg-card rounded-xl border border-border/50">
        <div class="relative flex-1">
            <lucide-icon name="search"
                class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"></lucide-icon>
            <input type="text" [ngModel]="searchQuery()" (ngModelChange)="searchQuery.set($event)"
                placeholder="Search by name or SKU..."
                class="w-full pl-10 pr-4 py-2 bg-muted/30 border border-border/50 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary/50 transition-all">
        </div>

        <div class="flex items-center gap-2">
            <button
                class="p-2 border border-border rounded-lg hover:bg-accent/50 text-muted-foreground hover:text-foreground"
                (click)="viewMode.set('list')" [class.bg-accent]="viewMode() === 'list'">
                <lucide-icon name="layout-list" class="w-4 h-4"></lucide-icon>
            </button>
            <button
                class="p-2 border border-border rounded-lg hover:bg-accent/50 text-muted-foreground hover:text-foreground"
                (click)="viewMode.set('grid')" [class.bg-accent]="viewMode() === 'grid'">
                <lucide-icon name="layout-grid" class="w-4 h-4"></lucide-icon>
            </button>
        </div>
    </div>

    <!-- Data Table -->
    <div *ngIf="viewMode() === 'list'" class="min-h-[400px]">
        <div class="overflow-x-auto rounded-xl border border-border/50 bg-card/50 backdrop-blur-sm">
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-border/50 bg-muted/20">
                        <th class="px-4 py-3 text-left font-medium text-muted-foreground">Product</th>
                        <th class="px-4 py-3 text-left font-medium text-muted-foreground">Category</th>
                        <th class="px-4 py-3 text-right font-medium text-muted-foreground">Price</th>
                        <th class="px-4 py-3 text-right font-medium text-muted-foreground">Inventory</th>
                        <th class="px-4 py-3 text-left font-medium text-muted-foreground">Marketplaces</th>
                        <th class="px-4 py-3 text-center font-medium text-muted-foreground">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-border/30">
                    <tr *ngFor="let product of filteredProducts()"
                        class="group hover:bg-primary/5 transition-colors cursor-pointer">
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-muted overflow-hidden">
                                    <img *ngIf="product.imageUrl" [src]="product.imageUrl"
                                        class="w-full h-full object-cover">
                                    <div *ngIf="!product.imageUrl"
                                        class="w-full h-full flex items-center justify-center text-xs text-muted-foreground">
                                        Img</div>
                                </div>
                                <div>
                                    <p class="font-medium">{{ product.name }}</p>
                                    <p class="text-xs text-muted-foreground">{{ product.sku }}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            <p>{{ product.category }}</p>
                        </td>
                        <td class="px-4 py-3 text-right">
                            <p class="font-semibold">₹{{ product.sellingPrice }}</p>
                        </td>
                        <td class="px-4 py-3 text-right">
                            <span [class]="product.totalInventory < 10 ? 'text-destructive' : ''">{{
                                product.totalInventory
                                }}</span>
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex flex-wrap gap-1">
                                <!-- TODO: Re-enable marketplaceListings loop when multi-marketplace data is available -->
                                <app-marketplace-badge
                                    [marketplace]="resolveMarketplaceName(product.marketplaceOrigin)"
                                    [status]="'live'"></app-marketplace-badge>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <div class="flex justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button (click)="handleEditProduct(product); $event.stopPropagation()"
                                    class="p-1.5 hover:bg-primary/10 rounded text-primary">
                                    <lucide-icon name="edit" class="w-4 h-4"></lucide-icon>
                                </button>
                                <button (click)="handleDeleteProduct(product); $event.stopPropagation()"
                                    class="p-1.5 hover:bg-destructive/10 rounded text-destructive">
                                    <lucide-icon name="trash-2" class="w-4 h-4"></lucide-icon>
                                </button>
                            </div>
                        </td>
                    </tr>
                    <tr *ngIf="filteredProducts().length === 0">
                        <td colspan="6" class="px-4 py-8 text-center text-muted-foreground">
                            No products found matching your search.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Grid View Placeholder -->
    <div *ngIf="viewMode() === 'grid'" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div *ngFor="let product of filteredProducts()"
            class="glass-card p-4 rounded-xl flex flex-col gap-3 group hover:-translate-y-1 transition-transform">
            <div class="aspect-square bg-muted rounded-lg overflow-hidden relative">
                <img *ngIf="product.imageUrl" [src]="product.imageUrl" class="w-full h-full object-cover">
                <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button (click)="handleEditProduct(product)"
                        class="p-2 bg-background/80 backdrop-blur rounded-full shadow-sm hover:text-primary">
                        <lucide-icon name="edit" class="w-4 h-4"></lucide-icon>
                    </button>
                </div>
            </div>
            <div>
                <h3 class="font-medium truncate">{{ product.name }}</h3>
                <p class="text-sm text-muted-foreground">{{ product.sku }}</p>
            </div>
            <div class="flex items-center justify-between mt-auto">
                <p class="font-bold">₹{{ product.sellingPrice }}</p>
                <span class="text-xs px-2 py-1 rounded bg-secondary">{{ product.totalInventory }} stock</span>
            </div>
        </div>
    </div>
</div>

<!-- Import Products Modal -->
<div *ngIf="importDialogOpen()" class="modal-backdrop" (click)="closeImportDialog()">
    <div class="modal-card small" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <div>
                <h2 class="text-lg font-display font-bold">Import Products</h2>
                <p class="text-sm text-muted-foreground">Upload Excel or CSV to bulk add products</p>
            </div>
            <button class="icon-button" (click)="closeImportDialog()">
                <lucide-icon name="x" class="w-4 h-4"></lucide-icon>
            </button>
        </div>

        <div class="modal-body">
            <label class="upload-box">
                <input type="file" accept=".xls,.xlsx,.csv" (change)="handleImportFile($event)" />
                <span>Click to upload Excel or CSV</span>
                <span class="upload-hint">.xls, .xlsx, or .csv</span>
            </label>

            <div class="file-pill" *ngIf="importFileName">
                <span>{{ importFileName }}</span>
                <button type="button" class="ghost-btn" (click)="importFileName = ''">Remove</button>
            </div>

            <div class="error-text" *ngIf="importFileError">{{ importFileError }}</div>

            <div class="modal-footer">
                <button type="button" class="ghost-btn" (click)="closeImportDialog()">Cancel</button>
                <button type="button" class="primary-btn" (click)="submitImport()">Import products</button>
            </div>

            <div class="h-px bg-border/50 my-2"></div>

            <div class="space-y-2">
                <p class="text-sm font-medium">Import from marketplace</p>
                <select
                    class="w-full px-3 py-2 bg-muted/30 border border-border/50 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary/50 transition-all"
                    [ngModel]="selectedImportStoreId()" (ngModelChange)="selectedImportStoreId.set($event)"
                    [disabled]="activeStores().length === 0 || importingMarketplace()">
                    <option value="">Select active store</option>
                    <option *ngFor="let store of activeStores()" [value]="store.id">
                        {{ getStoreLabel(store) }}
                    </option>
                </select>
                <p class="text-xs text-muted-foreground" *ngIf="activeStores().length === 0">
                    No active marketplace stores found.
                </p>
                <div class="modal-footer">
                    <button type="button" class="primary-btn" (click)="importFromMarketplace()"
                        [disabled]="!selectedImportStoreId() || importingMarketplace()">
                        {{ importingMarketplace() ? 'Importing...' : 'Import from marketplace' }}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Product Modal -->
<div *ngIf="addProductOpen()" class="modal-backdrop" (click)="closeAddProduct()">
    <div class="modal-card" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <div>
                <h2 class="text-xl font-display font-bold">{{ isEditing() ? 'Edit Product' : 'Add Product' }}</h2>
                <p class="text-sm text-muted-foreground">{{ isEditing() ? 'Update product details and inventory' : 'Create a new product and track inventory' }}</p>
            </div>
            <button class="icon-button" (click)="closeAddProduct()">
                <lucide-icon name="x" class="w-4 h-4"></lucide-icon>
            </button>
        </div>

        <form class="modal-body" (ngSubmit)="submitNewProduct()">
            <div class="form-grid">
                <label class="field">
                    <span class="field-label">Product name</span>
                    <input [(ngModel)]="name" name="name" required placeholder="Premium Tee - Midnight" />
                </label>

                <label class="field">
                    <span class="field-label">SKU</span>
                    <input [(ngModel)]="sku" name="sku" required placeholder="TEE-MID-001" />
                </label>

                <label class="field">
                    <span class="field-label">HSN code</span>
                    <input [(ngModel)]="hsnCode" name="hsnCode" placeholder="6109" />
                </label>

                <label class="field">
                    <span class="field-label">Category</span>
                    <input [(ngModel)]="category" name="category" placeholder="Apparel" />
                </label>

                <label class="field">
                    <span class="field-label">Brand</span>
                    <input [(ngModel)]="brand" name="brand" placeholder="Brand name" />
                </label>

                <label class="field">
                    <span class="field-label">Barcode</span>
                    <input [(ngModel)]="barcode" name="barcode" placeholder="8901234567890" />
                </label>

                <label class="field span-2">
                    <span class="field-label">Description</span>
                    <textarea [(ngModel)]="description" name="description" rows="3"
                        placeholder="Enter product details"></textarea>
                </label>
            </div>

            <div class="section">
                <div class="section-header">
                    <div>
                        <h3 class="section-title">Pricing</h3>
                        <p class="section-subtitle">All pricing fields from create product DTO</p>
                    </div>
                </div>

                <div class="form-grid">
                    <label class="field">
                        <span class="field-label">Purchase price</span>
                        <input [(ngModel)]="purchasePrice" name="purchasePrice" type="number" required placeholder="450" />
                    </label>

                    <label class="field">
                        <span class="field-label">Packaging cost</span>
                        <input [(ngModel)]="packagingCost" name="packagingCost" type="number" placeholder="20" />
                    </label>

                    <label class="field">
                        <span class="field-label">Shipping cost</span>
                        <input [(ngModel)]="shippingCost" name="shippingCost" type="number" placeholder="40" />
                    </label>

                    <label class="field">
                        <span class="field-label">Other cost</span>
                        <input [(ngModel)]="otherCost" name="otherCost" type="number" placeholder="10" />
                    </label>

                    <label class="field">
                        <span class="field-label">Selling price</span>
                        <input [(ngModel)]="sellingPrice" name="sellingPrice" type="number" required placeholder="899" />
                    </label>

                    <label class="field">
                        <span class="field-label">MRP</span>
                        <input [(ngModel)]="mrp" name="mrp" type="number" required placeholder="999" />
                    </label>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <div>
                        <h3 class="section-title">Inventory & Physical</h3>
                        <p class="section-subtitle">Stock, returns, and dimensions</p>
                    </div>
                </div>

                <div class="form-grid">
                    <label class="field">
                        <span class="field-label">Total inventory</span>
                        <input [(ngModel)]="inventory" name="inventory" type="number" required placeholder="120" />
                    </label>

                    <label class="field">
                        <span class="field-label">Sold quantity</span>
                        <input [(ngModel)]="soldQuantity" name="soldQuantity" type="number" placeholder="0" />
                    </label>

                    <label class="field">
                        <span class="field-label">Return quantity</span>
                        <input [(ngModel)]="returnQuantity" name="returnQuantity" type="number" placeholder="0" />
                    </label>

                    <label class="field">
                        <span class="field-label">Pending return quantity</span>
                        <input [(ngModel)]="pendingReturnQuantity" name="pendingReturnQuantity" type="number"
                            placeholder="0" />
                    </label>

                    <label class="field">
                        <span class="field-label">Damaged quantity</span>
                        <input [(ngModel)]="damagedQuantity" name="damagedQuantity" type="number" placeholder="0" />
                    </label>

                    <label class="field">
                        <span class="field-label">Weight</span>
                        <input [(ngModel)]="weight" name="weight" type="number" placeholder="0.5" />
                    </label>

                    <label class="field">
                        <span class="field-label">Length</span>
                        <input [(ngModel)]="length" name="length" type="number" placeholder="12" />
                    </label>

                    <label class="field">
                        <span class="field-label">Width</span>
                        <input [(ngModel)]="width" name="width" type="number" placeholder="8" />
                    </label>

                    <label class="field">
                        <span class="field-label">Height</span>
                        <input [(ngModel)]="height" name="height" type="number" placeholder="2" />
                    </label>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <div>
                        <h3 class="section-title">Marketplace</h3>
                        <p class="section-subtitle">Origin and marketplace specific prices</p>
                    </div>
                </div>

                <div class="form-grid">
                    <label class="field">
                        <span class="field-label">Marketplace origin</span>
                        <input [(ngModel)]="marketplaceOrigin" name="marketplaceOrigin"
                            placeholder="amazon/flipkart/meesho..." />
                    </label>

                    <label class="field">
                        <span class="field-label">Amazon price</span>
                        <input [(ngModel)]="amazonPrice" name="amazonPrice" type="number" placeholder="0" />
                    </label>

                    <label class="field">
                        <span class="field-label">Flipkart price</span>
                        <input [(ngModel)]="flipkartPrice" name="flipkartPrice" type="number" placeholder="0" />
                    </label>

                    <label class="field">
                        <span class="field-label">Meesho price</span>
                        <input [(ngModel)]="meeshoPrice" name="meeshoPrice" type="number" placeholder="0" />
                    </label>

                    <label class="field">
                        <span class="field-label">Ajio price</span>
                        <input [(ngModel)]="ajioPrice" name="ajioPrice" type="number" placeholder="0" />
                    </label>

                    <label class="field">
                        <span class="field-label">Myntra price</span>
                        <input [(ngModel)]="myntraPrice" name="myntraPrice" type="number" placeholder="0" />
                    </label>

                    <label class="field">
                        <span class="field-label">Tatacliq price</span>
                        <input [(ngModel)]="tatacliqPrice" name="tatacliqPrice" type="number" placeholder="0" />
                    </label>

                    <label class="field">
                        <span class="field-label">Jiomart price</span>
                        <input [(ngModel)]="jiomartPrice" name="jiomartPrice" type="number" placeholder="0" />
                    </label>

                    <label class="toggle">
                        <input type="checkbox" [(ngModel)]="isActive" name="isActive" />
                        <span>Product is active</span>
                    </label>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <div>
                        <h3 class="section-title">Images</h3>
                        <p class="section-subtitle">Upload product shots or add image URLs</p>
                    </div>
                    <button type="button" class="secondary-btn" (click)="openImageDialog()">
                        Add Images
                    </button>
                </div>

                <div class="image-grid" *ngIf="imageItems.length > 0">
                    <div class="image-card" *ngFor="let img of imageItems; let i = index">
                        <img [src]="img.preview" alt="Product image">
                        <button type="button" class="remove-image" (click)="removeImage(i)">Remove</button>
                    </div>
                </div>

                <div class="empty-note" *ngIf="imageItems.length === 0">
                    No images added yet.
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <div>
                        <h3 class="section-title">Variations</h3>
                        <p class="section-subtitle">Add options like size, color, or material</p>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" [checked]="hasVariants()" (change)="hasVariants.set(!hasVariants())" />
                        <span>Enable variations</span>
                    </label>
                </div>

                <div *ngIf="hasVariants()" class="variant-list">
                    <div class="variant-row" *ngFor="let v of variations; let i = index">
                        <label class="field">
                            <span class="field-label">Option name</span>
                            <input [(ngModel)]="v.name" name="variationName{{i}}" placeholder="Size" />
                        </label>
                        <label class="field">
                            <span class="field-label">Values</span>
                            <input [(ngModel)]="v.values" name="variationValues{{i}}" placeholder="S, M, L, XL" />
                        </label>
                        <button type="button" class="ghost-btn" (click)="removeVariation(i)">Remove</button>
                    </div>

                    <button type="button" class="secondary-btn" (click)="addVariation()">Add variation</button>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="ghost-btn" (click)="closeAddProduct()">Cancel</button>
                <button type="submit" class="primary-btn">{{ isEditing() ? 'Update product' : 'Create product' }}</button>
            </div>
        </form>
    </div>
</div>

<!-- Image Popup -->
<div *ngIf="imageDialogOpen()" class="modal-backdrop" (click)="closeImageDialog()">
    <div class="modal-card small" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <div>
                <h2 class="text-lg font-display font-bold">Add Images</h2>
                <p class="text-sm text-muted-foreground">Upload files or paste image URLs</p>
            </div>
            <button class="icon-button" (click)="closeImageDialog()">
                <lucide-icon name="x" class="w-4 h-4"></lucide-icon>
            </button>
        </div>

        <div class="modal-body">
            <label class="upload-box">
                <input type="file" accept="image/*" multiple (change)="handleImageUpload($event)" />
                <span>Click to upload images</span>
                <span class="upload-hint">PNG, JPG up to 5MB</span>
            </label>

            <div class="url-row">
                <input [(ngModel)]="imageUrlInput" name="imageUrlInput" placeholder="https://image-url.com/product.jpg" />
                <button type="button" class="secondary-btn" (click)="addImageUrl()">Add URL</button>
            </div>

            <div class="image-grid" *ngIf="imageItems.length > 0">
                <div class="image-card" *ngFor="let img of imageItems; let i = index">
                    <img [src]="img.preview" alt="Product image">
                    <button type="button" class="remove-image" (click)="removeImage(i)">Remove</button>
                </div>
            </div>
        </div>
    </div>
</div>
